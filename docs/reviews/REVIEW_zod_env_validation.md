# Code Review: Zod-–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**Reviewed:**
- `src/infrastructure/shared/config/envSchema.ts` (–Ω–æ–≤—ã–π)
- `src/infrastructure/shared/config/AppConfig.ts` (–∏–∑–º–µ–Ω—ë–Ω)
- `src/infrastructure/shared/config/index.ts` (–∏–∑–º–µ–Ω—ë–Ω)
- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤ 5 —Ñ–∞–π–ª–∞—Ö

**Date:** 2025-12-24
**Status:** üü° Approved with comments

---

## Summary

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ zod —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —É—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (JUPITER_API_KEY, WEBHOOK_URL, HTTPS) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ `.superRefine()`, –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤—Å–µ —Å—Ä–∞–∑—É. –û–¥–Ω–∞–∫–æ —Ç–∏–ø—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (`Config`, `TelegramConfig` –∏ –¥—Ä.) –Ω–∞–ø–∏—Å–∞–Ω—ã –≤—Ä—É—á–Ω—É—é, –∞ –Ω–µ –≤—ã–≤–µ–¥–µ–Ω—ã –∏–∑ —Å—Ö–µ–º—ã —á–µ—Ä–µ–∑ `z.infer` ‚Äî —ç—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç acceptance criteria –∏ —Å–æ–∑–¥–∞—ë—Ç —Ä–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## Findings

### üü° Should Fix (important but not blocking)

#### [S1] –¢–∏–ø—ã –Ω–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ zod-—Å—Ö–µ–º—ã

**Location:** `src/infrastructure/shared/config/envSchema.ts:106-178`
**Issue:** Acceptance criteria —Ç—Ä–µ–±—É–µ—Ç: "–¢–∏–ø—ã `Config` –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ zod-—Å—Ö–µ–º—ã (`z.infer`)". –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (`TelegramConfig`, `Config` –∏ –¥—Ä.) –Ω–∞–ø–∏—Å–∞–Ω—ã –≤—Ä—É—á–Ω—É—é –∏ –¥—É–±–ª–∏—Ä—É—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ö–µ–º—ã.
**Impact:** –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å—Ö–µ–º–æ–π –∏ —Ç–∏–ø–∞–º–∏ –ø—Ä–∏ –±—É–¥—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö. –ù–∞—Ä—É—à–µ–Ω–∏–µ DRY.
**Suggestion:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `z.infer` –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–∏–ø–æ–≤:
```typescript
// –í–º–µ—Å—Ç–æ —Ä—É—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
const configSchema = z.object({
  telegram: z.object({ botToken: z.string() }),
  // ...
});
export type Config = z.infer<typeof configSchema>;
```
–ò–ª–∏ –∫–∞–∫ –º–∏–Ω–∏–º—É–º ‚Äî –≤—ã–≤–µ—Å—Ç–∏ —Ç–∏–ø ValidatedEnv –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ.

---

#### [S2] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è isDev

**Location:**
- `src/infrastructure/shared/config/AppConfig.ts:14-15`
- `src/infrastructure/shared/config/envSchema.ts:182`

**Issue:** `isDev` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã: –≤ `loadConfig()` –∏ –≤ `envToConfig()`. –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç —Ä–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏.
**Suggestion:** –í—ã—á–∏—Å–ª—è—Ç—å `isDev` —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ ‚Äî –ª–∏–±–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–∑ `loadConfig()`, –ª–∏–±–æ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ `envToConfig()`.

---

### üü¢ Consider (nice to have, minor improvements)

#### [N1] WEB_ENABLED –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å

**Location:** `src/infrastructure/shared/config/envSchema.ts:46-49`
**Observation:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `.transform()` –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏ –≤ boolean.
**Suggestion:** –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω —Å preprocess:
```typescript
WEB_ENABLED: z.preprocess(
  (v) => v === "true" || v === "1",
  z.boolean()
).default(false),
```

---

#### [N2] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è DCA_AMOUNT_USDC

**Location:** `src/infrastructure/shared/config/envSchema.ts:38`
**Observation:** `.positive()` —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ª—é–±–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –≤–∫–ª—é—á–∞—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ (0.0001 USDC).
**Suggestion:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å `.min(1)` –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ä–∞–∑—É–º–Ω—ã–π –º–∏–Ω–∏–º—É–º –¥–ª—è DCA —Å—É–º–º—ã.

---

#### [N3] MASTER_ENCRYPTION_KEY regex –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å base64

**Location:** `src/infrastructure/shared/config/envSchema.ts:14-16`
**Observation:** Regex `/^[A-Za-z0-9+/=]{43,44}$/` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è —Ä–æ–≤–Ω–æ –≤ 32 –±–∞–π—Ç–∞.
**Suggestion:** –î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `.refine()` —Å Buffer.from(v, 'base64').length === 32. –û–¥–Ω–∞–∫–æ —Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ—à–µ–Ω–∏—é PM ("–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞").

---

## Checklist Results

| Category | Status | Notes |
|----------|--------|-------|
| Correctness | ‚úÖ | –í—Å–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Architecture | ‚úÖ | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ infrastructure/shared –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, domain –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ |
| Security | ‚úÖ | DEV_WALLET_PRIVATE_KEY –æ—á–∏—â–∞–µ—Ç—Å—è –∏–∑ process.env, sensitive data –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è |
| Code Quality | ‚ö†Ô∏è | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ isDev, —Ç–∏–ø—ã –Ω–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ —Å—Ö–µ–º—ã |
| Conventions | ‚úÖ | Trailing commas, –∫–æ–º–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, —Å—Ç–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–µ–∫—Ç—É |

---

## Acceptance Criteria Verification

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `zod` | ‚úÖ |
| –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `envSchema.ts` —Å zod-—Å—Ö–µ–º–æ–π | ‚úÖ |
| –í—Å–µ env variables –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ | ‚úÖ |
| –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –í–°–ï –æ—à–∏–±–∫–∏ | ‚úÖ |
| –¢–∏–ø—ã `Config` –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ zod-—Å—Ö–µ–º—ã (`z.infer`) | ‚ö†Ô∏è –ù–∞–ø–∏—Å–∞–Ω—ã –≤—Ä—É—á–Ω—É—é |
| `loadConfig()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ö–µ–º—É | ‚úÖ |
| –õ–æ–≥–∏–∫–∞ forbidden vars –≤ production —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | ‚úÖ |
| `.env.example` –∞–∫—Ç—É–∞–ª–µ–Ω | ‚úÖ |

---

## Action Items

- [ ] [S1] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥: –≤—ã–≤–µ—Å—Ç–∏ —Ç–∏–ø—ã –∏–∑ —Å—Ö–µ–º—ã —á–µ—Ä–µ–∑ `z.infer` –∏–ª–∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Ä—É—á–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- [ ] [S2] –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è `isDev`
