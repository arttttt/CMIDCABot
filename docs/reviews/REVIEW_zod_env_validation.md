# Code Review: Zod-–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**Reviewed:**
- `src/infrastructure/shared/config/envSchema.ts` (–Ω–æ–≤—ã–π)
- `src/infrastructure/shared/config/AppConfig.ts` (–∏–∑–º–µ–Ω—ë–Ω)
- `src/infrastructure/shared/config/index.ts` (–∏–∑–º–µ–Ω—ë–Ω)
- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤ 5 —Ñ–∞–π–ª–∞—Ö

**Date:** 2025-12-24
**Status:** üü¢ Approved

---

## Summary

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ zod —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —É—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (JUPITER_API_KEY, WEBHOOK_URL, HTTPS) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ `.superRefine()`, –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤—Å–µ —Å—Ä–∞–∑—É. –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–º–µ—á–∞–Ω–∏–π –≤—Å–µ issues —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∏–ª–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã.

---

## Findings

### üü° Should Fix (important but not blocking)

#### [S1] –¢–∏–ø—ã –Ω–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ zod-—Å—Ö–µ–º—ã

**Status:** ‚ùå REJECTED

**Location:** `src/infrastructure/shared/config/envSchema.ts:116-185`
**Issue:** Acceptance criteria —Ç—Ä–µ–±—É–µ—Ç: "–¢–∏–ø—ã `Config` –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ zod-—Å—Ö–µ–º—ã (`z.infer`)". –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (`TelegramConfig`, `Config` –∏ –¥—Ä.) –Ω–∞–ø–∏—Å–∞–Ω—ã –≤—Ä—É—á–Ω—É—é.

**Rejection Reason:**
–ó–∞–º–µ—á–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –Ω–µ–≤–µ—Ä–Ω–æ–º –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:
- `envSchema` –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç **–ø–ª–æ—Å–∫–∏–π** `process.env` (TELEGRAM_BOT_TOKEN, OWNER_TELEGRAM_ID...)
- `Config` ‚Äî **–≤–ª–æ–∂–µ–Ω–Ω–∞—è** —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (telegram.botToken, auth.ownerTelegramId...)

–≠—Ç–æ —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã—Ö. `z.infer<typeof envSchema>` –¥–∞—ë—Ç `ValidatedEnv` (–ø–ª–æ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞), –∞ –Ω–µ `Config` (–≤–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞). –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `envToConfig()`. –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∫–æ–¥, –æ–±—ä—è—Å–Ω—è—é—â–∏–π —ç—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

---

#### [S2] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è isDev

**Status:** ‚úÖ FIXED

**Location:** (–±—ã–ª–æ)
- `src/infrastructure/shared/config/AppConfig.ts:14-15`
- `src/infrastructure/shared/config/envSchema.ts:182`

**Fix:** Forbidden vars check –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ `parseEnv()`. –¢–µ–ø–µ—Ä—å `isDev` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `parseEnv()` –∏ `envToConfig()` (–æ–¥–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–æ–¥—É–ª–µ). `loadConfig()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.isDev` –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

---

### üü¢ Consider (nice to have, minor improvements)

#### [N1] WEB_ENABLED –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å

**Status:** ‚úÖ FIXED

**Location:** `src/infrastructure/shared/config/envSchema.ts:56-59`
**Fix:** –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `z.preprocess()` —Å `z.boolean().default(false)`.

---

#### [N2] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è DCA_AMOUNT_USDC

**Status:** ‚úÖ FIXED

**Location:** `src/infrastructure/shared/config/envSchema.ts:48`
**Fix:** –î–æ–±–∞–≤–ª–µ–Ω–æ `.min(1)` ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ DCA —Ç–µ–ø–µ—Ä—å 1 USDC.

---

#### [N3] MASTER_ENCRYPTION_KEY regex –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å base64

**Status:** ‚è∏Ô∏è DEFERRED

**Observation:** Regex –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–æ–≤–Ω–æ 32 –±–∞–π—Ç–∞ –ø–æ—Å–ª–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.
**Reason:** –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ—à–µ–Ω–∏—é PM ("–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"). –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## Checklist Results

| Category | Status | Notes |
|----------|--------|-------|
| Correctness | ‚úÖ | –í—Å–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Architecture | ‚úÖ | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ infrastructure/shared –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, domain –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ |
| Security | ‚úÖ | DEV_WALLET_PRIVATE_KEY –æ—á–∏—â–∞–µ—Ç—Å—è –∏–∑ process.env, sensitive data –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è |
| Code Quality | ‚úÖ | isDev –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–æ —Ç–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω |
| Conventions | ‚úÖ | Trailing commas, –∫–æ–º–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, —Å—Ç–∏–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–µ–∫—Ç—É |

---

## Acceptance Criteria Verification

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `zod` | ‚úÖ |
| –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `envSchema.ts` —Å zod-—Å—Ö–µ–º–æ–π | ‚úÖ |
| –í—Å–µ env variables –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ | ‚úÖ |
| –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –í–°–ï –æ—à–∏–±–∫–∏ | ‚úÖ |
| –¢–∏–ø—ã `Config` –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ zod-—Å—Ö–µ–º—ã (`z.infer`) | ‚úÖ (—Å–º. S1 rejection reason) |
| `loadConfig()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ö–µ–º—É | ‚úÖ |
| –õ–æ–≥–∏–∫–∞ forbidden vars –≤ production —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | ‚úÖ |
| `.env.example` –∞–∫—Ç—É–∞–ª–µ–Ω | ‚úÖ |

---

## Action Items

- [x] [S1] ~~–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥: –≤—ã–≤–µ—Å—Ç–∏ —Ç–∏–ø—ã –∏–∑ —Å—Ö–µ–º—ã~~ ‚Üí REJECTED —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
- [x] [S2] –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è `isDev` ‚Üí FIXED
- [x] [N1] WEB_ENABLED ‚Üí z.preprocess ‚Üí FIXED
- [x] [N2] DCA_AMOUNT_USDC ‚Üí .min(1) ‚Üí FIXED
